<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelime ve Görsel Eşleştirme</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="center-container">
        <div class="container">
            <h1 style="margin-bottom: 24px; text-align: center;">
                <!-- Ücretsiz Terapi Uygulaması İçin Destek Olun -->
            </h1>
            <div class="instructions">
                <strong>Açıklama:</strong> Görseldeki kelimeyi tahmin etmeye calis.
            </div>
            <hr style="width: 60%; margin: 24px auto;">
            {% if image_url %}
            <div class="image-wrapper">
                <img src="{{ image_url }}" alt="Resim" class="main-image">
            </div>
            <div id="censored-word" style="text-align:center; font-size:2em; margin-bottom:20px; letter-spacing: 0.2em;">
                {{ censored }}
            </div>
            <div style="text-align:center;">
                <button id="hint-btn" class="hint-btn">ipucu al</button>
                <button id="next-btn" class="next-btn" onclick="window.location.reload()">sonraki resim</button>
            </div>
            <hr style="width: 60%; margin: 24px auto;">
            <div style="text-align:center; margin-top: 20px;">
                <div class="instructions" style="margin-bottom: 10px;">Kendi sesinizi kaydedip, dinleyin.</div>
                <button id="record-btn" class="record-btn">Kaydı Başlat</button>
                <button id="stop-btn" class="stop-btn" disabled>Kaydı Durdur</button>
                <audio id="audio-recording" controls style="display:none;"></audio>
            </div>
            <hr style="width: 60%; margin: 24px auto;">
            <div style="text-align:center; margin-top: 20px;">
                <button id="pronounce-btn" class="pronounce-btn">Doğru Söylenişi Dinle</button>
                <audio id="audio-pronounce" controls style="display:none;"></audio>
            </div>
            {% endif %}
        </div>
    </div>
    <script>
    document.getElementById('hint-btn').addEventListener('click', function(e) {
        e.preventDefault();
        fetch("{{ url_for('hint') }}", { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                document.getElementById('censored-word').textContent = data.censored;
            });
    });

    // --- Audio Recording and Playback ---
    let mediaRecorder;
    let audioChunks = [];
    const recordBtn = document.getElementById('record-btn');
    const stopBtn = document.getElementById('stop-btn');
    const audioRecording = document.getElementById('audio-recording');

    recordBtn.onclick = async function() {
        audioChunks = [];
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        recordBtn.disabled = true;
        stopBtn.disabled = false;
        mediaRecorder.ondataavailable = e => {
            audioChunks.push(e.data);
        };
        mediaRecorder.onstop = e => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            audioRecording.src = URL.createObjectURL(audioBlob);
            audioRecording.style.display = 'block';
            audioRecording.play();
        };
    };
    stopBtn.onclick = function() {
        mediaRecorder.stop();
        recordBtn.disabled = false;
        stopBtn.disabled = true;
    };

    // --- Pronunciation (TTS) ---
    const pronounceBtn = document.getElementById('pronounce-btn');
    const audioPronounce = document.getElementById('audio-pronounce');
    pronounceBtn.onclick = function() {
        fetch('/pronounce')
            .then(response => response.blob())
            .then(blob => {
                const url = URL.createObjectURL(blob);
                audioPronounce.src = url;
                audioPronounce.style.display = 'block';
                audioPronounce.play();
            });
    };
    </script>
</body>
</html>