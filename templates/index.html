{% extends "layout.html" %}

{% block title %}Hoş Geldiniz - Terapi Uygulaması{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
        <!-- Welcome Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 fw-bold text-primary mb-3">Hoş Geldin! 👋</h1>
            <p class="lead text-muted">
                Dil becerilerinizi eğlenceli oyunlarla geliştirin! 😊
            </p>
        </div>

        <!-- Analytics Section -->
        {% if analytics_data %}
        <div class="mb-5">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h5 class="mb-0 text-dark">⏰ Günlük Çalışma ve Hedef Süreleri</h5>
                </div>
                <div class="card-body">
                    {% if analytics_data|length > 0 %}
                    <div id="success-message" style="display: none;" class="alert alert-success mb-3">
                        <i class="bi bi-check-circle-fill me-2"></i>
                        <strong>Tebrikler!</strong> Bugünkü hedefinize ulaştınız! 🎉
                    </div>
                    <div id="motivation-message" style="display: none;" class="alert alert-info mb-3">
                        <i class="bi bi-star-fill me-2"></i>
                        <strong>Devam edin!</strong> Hedefinize yaklaşıyorsunuz! 💪
                    </div>
                    <div style="height: 450px;">
                        <canvas id="sessionChart"></canvas>
                    </div>
                    {% else %}
                    <p class="text-muted mb-0">Henüz oturum verisi bulunmuyor.</p>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Games Grid -->
        <div class="row g-4">
            <!-- Word Guessing Game -->
            <div class="col-md-6 col-lg-4">
                <div class="card game-card h-100 shadow-sm">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="game-icon mb-3">
                            📖
                        </div>
                        <h5 class="card-title">Kelime Çalışması</h5>
                        <p class="card-text flex-grow-1">
                            Resimlere bakarak kelimeleri tahmin edin
                        </p>
                        <small class="text-muted mb-3">Resimlere bağlı kelimeler</small>
                        <a href="{{ url_for('word_guessing.index') }}" class="btn btn-primary game-btn">
                            Başla <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Breathing Exercise -->
            <div class="col-md-6 col-lg-4">
                <div class="card game-card h-100 shadow-sm">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="game-icon mb-3">
                            🫁
                        </div>
                        <h5 class="card-title">Nefes Egzersizi</h5>
                        <p class="card-text flex-grow-1">
                            Rahatlamak için nefes egzersizleri yapın
                        </p>
                        <small class="text-muted mb-3">Rahatlatıcı nefes teknikleri</small>
                        <a href="{{ url_for('breathing_bp.index') }}" class="btn btn-primary game-btn">
                            Başla <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Fill in the Blanks -->
            <div class="col-md-6 col-lg-4">
                <div class="card game-card h-100 shadow-sm">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="game-icon mb-3">
                            📝
                        </div>
                        <h5 class="card-title">Boşluk Doldurma</h5>
                        <p class="card-text flex-grow-1">
                            Cümlelerdeki eksik kelimeleri bulun
                        </p>
                        <small class="text-muted mb-3">Cümlerdeki eksik kelimeler</small>
                        <a href="{{ url_for('bosluk_bp.index') }}" class="btn btn-primary game-btn">
                            Başla <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Memory Game -->
            <div class="col-md-6 col-lg-4">
                <div class="card game-card h-100 shadow-sm">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="game-icon mb-3">
                            🧠
                        </div>
                        <h5 class="card-title">Hafıza Çalışması</h5>
                        <p class="card-text flex-grow-1">
                            Sayıları hatırlayarak hafızanızı güçlendirin
                        </p>
                        <small class="text-muted mb-3">Sayıları hatırlayın</small>
                        <a href="{{ url_for('memory_bp.index') }}" class="btn btn-primary game-btn">
                            Başla <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Image Memory -->
            <div class="col-md-6 col-lg-4">
                <div class="card game-card h-100 shadow-sm">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="game-icon mb-3">
                            🖼️
                        </div>
                        <h5 class="card-title">Resim Hafızası</h5>
                        <p class="card-text flex-grow-1">
                            Resimleri hatırlayarak görsel hafızanızı geliştirin
                        </p>
                        <small class="text-muted mb-3">Resimleri hatırlayın</small>
                        <a href="{{ url_for('image_memory_bp.index') }}" class="btn btn-primary game-btn">
                            Başla <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Pronunciation Exercise -->
            <div class="col-md-6 col-lg-4">
                <div class="card game-card h-100 shadow-sm">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="game-icon mb-3">
                            🎤
                        </div>
                        <h5 class="card-title">Telaffuz Çalışması</h5>
                        <p class="card-text flex-grow-1">
                            Kelimelerinizi doğrulayın ve öğrenin
                        </p>
                        <small class="text-muted mb-3">Kelimelerinizi doğru telaffuz edin</small>
                        <a href="{{ url_for('word_pronunciation.index') }}" class="btn btn-primary game-btn">
                            Başla <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Listening Exercise -->
            <div class="col-md-6 col-lg-4">
                <div class="card game-card h-100 shadow-sm">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="game-icon mb-3">
                            👂
                        </div>
                        <h5 class="card-title">Dinleme Egzersizi</h5>
                        <p class="card-text flex-grow-1">
                            Dinlediğiniz kelime ve cümleleri yazın
                        </p>
                        <small class="text-muted mb-3">Dinlediğinizi yazın</small>
                        <a href="{{ url_for('pronunciation_game.index') }}" class="btn btn-primary game-btn">
                            Başla <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Reverse Dictionary Exercise -->
            <div class="col-md-6 col-lg-4">
                <div class="card game-card h-100 shadow-sm">
                    <div class="card-body text-center d-flex flex-column">
                        <div class="game-icon mb-3">
                            📖
                        </div>
                        <h5 class="card-title">Ters Sözlük</h5>
                        <p class="card-text flex-grow-1">
                            Tanımından kelimeyi bulun
                        </p>
                        <small class="text-muted mb-3">Tanımı okuyun veya dinleyin</small>
                        <a href="{{ url_for('reverse_dictionary.index') }}" class="btn btn-primary game-btn">
                            Başla <i class="bi bi-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.welcome-heart {
    font-size: 4rem;
    animation: heartbeat 2s ease-in-out infinite;
}

@keyframes heartbeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.game-card {
    transition: all 0.3s ease;
    border: none;
    border-radius: 15px;
}

.game-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
}

.game-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
}

.game-btn {
    border-radius: 25px;
    padding: 0.75rem 2rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.game-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(0,123,255,0.3);
}

.stars {
    font-size: 1.5rem;
    color: #ffc107;
}

.rating-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 15px;
    padding: 1.5rem;
    display: inline-block;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% if analytics_data and analytics_data|length > 0 %}
<script type="application/json" id="analytics-data">{{ analytics_data | tojson | safe }}</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('sessionChart').getContext('2d');
    const data = JSON.parse(document.getElementById('analytics-data').textContent);
    
    // Filter out current date (today)
    const today = new Date().toLocaleDateString('en-GB', {
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric'
    }).replace(/\//g, '-');
    
    const filteredData = data.filter(item => item.day !== today);
    
    // Calculate linear trend line using least squares regression
    function calculateLinearTrend(values) {
        const n = values.length;
        if (n < 2) return values; // Need at least 2 points for a line
        
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
        
        values.forEach((y, x) => {
            sumX += x;
            sumY += y;
            sumXY += x * y;
            sumXX += x * x;
        });
        
        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;
        
        return values.map((_, x) => slope * x + intercept);
    }
    
    const trendValues = calculateLinearTrend(filteredData.map(item => item.total_session_time_minutes));
    
    // Calculate target for current date using tiered system
    const lastTrendValue = trendValues.length > 0 ? trendValues[trendValues.length - 1] : 0;
    
    function calculateTarget(trendMinutes) {
        if (trendMinutes < 60) {
            return Math.round(trendMinutes * 2); // 100% addition
        } else if (trendMinutes < 120) {
            return Math.round(trendMinutes * 1.5); // 50% addition
        } else if (trendMinutes < 180) {
            return Math.round(trendMinutes * 1.25); // 25% addition
        } else if (trendMinutes < 240) {
            return Math.round(trendMinutes * 1.15); // 15% addition
        } else if (trendMinutes < 300) {
            return Math.round(trendMinutes * 1.1); // 10% addition
        } else if (trendMinutes < 360) {
            return Math.round(trendMinutes * 1.05); // 5% addition
        } else if (trendMinutes < 420) {
            return Math.round(trendMinutes * 1.01); // 1% addition
        } else {
            return 420; // Cap at 420 minutes
        }
    }
    
    const targetValue = calculateTarget(lastTrendValue);
    
    // Check if today's target is achieved
    const todayData = data.find(item => item.day === today);
    const todayMinutes = todayData ? todayData.total_session_time_minutes : 0;
    if (todayMinutes >= targetValue && targetValue > 0) {
        document.getElementById('success-message').style.display = 'block';
    } else if (todayMinutes > 0 && targetValue > 0) {
        document.getElementById('motivation-message').style.display = 'block';
    }
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(item => item.day),
            datasets: [{
                label: 'Dakika',
                data: data.map(item => item.total_session_time_minutes),
                backgroundColor: '#0d6efd',
                borderColor: '#0d6efd',
                borderWidth: 1,
                order: 2
            }, {
                label: 'Trend',
                type: 'line',
                data: data.map((item, index) => {
                    // Only show trend for filtered data (excluding today)
                    const filteredIndex = filteredData.findIndex(f => f.day === item.day);
                    return filteredIndex >= 0 ? trendValues[filteredIndex] : null;
                }),
                borderColor: '#dc3545',
                backgroundColor: 'transparent',
                borderWidth: 2,
                pointBackgroundColor: '#dc3545',
                pointBorderColor: '#dc3545',
                pointRadius: 3,
                tension: 0, // Make it perfectly linear
                spanGaps: false,
                order: 1
            }, {
                label: 'Bugünün hedefi',
                type: 'line',
                data: data.map((item) => {
                    // Only show target for current date
                    return item.day === today ? targetValue : null;
                }),
                borderColor: '#28a745',
                backgroundColor: 'transparent',
                borderWidth: 3,
                borderDash: [10, 5],
                pointBackgroundColor: '#28a745',
                pointBorderColor: '#28a745',
                pointRadius: 6,
                spanGaps: false,
                order: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        filter: function(item, chart) {
                            return item.text !== 'Dakika' && item.text !== 'Bugünün hedefi';
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 0) {
                                return context.parsed.y + ' dakika';
                            } else if (context.datasetIndex === 1) {
                                return 'Trend: ' + context.parsed.y + ' dakika';
                            } else {
                                return 'Hedef: ' + context.parsed.y + ' dakika';
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Dakika'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'Tarih'
                    }
                }
            },
            animation: {
                duration: 1000,
                easing: 'easeInOutCubic',
                onComplete: function() {
                    const chart = this;
                    const ctx = chart.ctx;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillStyle = '#28a745';
                    ctx.font = 'bold 12px Arial';
                    
                    // Show target label only
                    const targetDataset = chart.data.datasets[2]; // Target dataset
                    const meta = chart.getDatasetMeta(2);
                    meta.data.forEach(function(point, index) {
                        const value = targetDataset.data[index];
                        if (value && value > 0) {
                            ctx.fillText('Günün hedefi:', point.x, point.y - 20);
                            ctx.fillText(value + ' dk', point.x, point.y - 5);
                        }
                    });
                }
            }
        }
    });
});
</script>
{% endif %}
{% endblock %}
